<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{fragments/layout}"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<!-- ##1 -->
<head>
<meta charset="UTF-8">
<title>마이페이지</title>
</head>
<body style="background-color:#D9D9D9">
	<div layout:fragment="content">

		<div class="container d-flex flex-column justify-content-center align-items-center">

			<div class="container bg-secondary rounded-top-5" style="max-width: 1000px; height: 20px;"></div>
			
			<div class="container bg-secondary d-flex" style="max-width: 1000px; height: 300px;">
				<div class="container bg-secondary d-flex align-items-center" style="max-width: 30%; max-height: 100%;">
				  <section class="bg-white rounded-circle d-flex justify-content-center align-items-center position-relative" style="width: 100%; height: 90%;">
				    
				     <!-- 아바타 이미지-->
				    <img src="/40db/images/member_avatar.png" alt="아바타" class="position-absolute" style="z-index: 1; max-width: 90%; max-height: 80%;">
				    	
				    <div class="d-none" style="z-index: 2; position: relative; color: gray;">아바타 바꾸기</div>
				
				  </section>
				</div>
				
				<!-- 사용자 별명(displayName) -->
				<div class="container bg-secondary text-white d-flex flex-column" style="max-width: 60%; max-height: 100%;">
						  <h1 class="row align-items-end text-white displayName2" id="displayName2" style="font-size: 55px; height: 50%"></h1>
						  <span class="badge bg-dark col-6 memberId2" style="font-size: 15px" sec:authorize="isAuthenticated()"  sec:authentication="principal.username" id="memberId2"></span>
				</div>
			
			</div>
			
			<div class="container bg-secondary" style="max-width: 1000px; height: 10px;"></div>
			<div class="container bg-secondary rounded-bottom-3" style="max-width: 1000px; height: 800px;">
			  <div class="d-flex container bg-light rounded-bottom-3 rounded-top-3 justify-content-end" style="max-width: 100%; height: 99%;">
  
			<!-- 메인 -->
			<div class="bg-white shadow-lg rounded-3 me-auto" style="width: 74%; padding: 50px 32px; font-size: 1.1rem;">
			
			    <h1 class="mb-4 text-primary"><svg xmlns="http://www.w3.org/2000/svg" width="42" height="42" fill="currentColor" class="bi bi-shield-lock" viewBox="0 0 16 16">
			  <path d="M5.338 1.59a61 61 0 0 0-2.837.856.48.48 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.7 10.7 0 0 0 2.287 2.233c.346.244.652.42.893.533q.18.085.293.118a1 1 0 0 0 .101.025 1 1 0 0 0 .1-.025q.114-.034.294-.118c.24-.113.547-.29.893-.533a10.7 10.7 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.8 11.8 0 0 1-2.517 2.453 7 7 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7 7 0 0 1-1.048-.625 11.8 11.8 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 63 63 0 0 1 5.072.56"/>
			  <path d="M9.5 6.5a1.5 1.5 0 0 1-1 1.415l.385 1.99a.5.5 0 0 1-.491.595h-.788a.5.5 0 0 1-.49-.595l.384-1.99a1.5 1.5 0 1 1 2-1.415"/>
			</svg> 비밀번호 변경</h1>
			
			    <!-- 폼 -->
			    <form method="post" th:action="@{/member/mypage/upass}" style="display: flex; flex-direction: column; align-items: center; gap: 25px; margin-top:5rem">
			
			        <!-- 숨겨진 memberId 필드 -->
			        <div class="form-floating w-75 d-none">
			            <input type="text" name="memberId" id="memberId" class="form-control" th:value="${#authentication.name}" readonly>
			            <label for="memberId">Member ID</label>
			        </div>
			
			        <!-- 기존 비밀번호 -->
			        <div class="form-floating mb-3 w-75">
			            <input type="password" name="oldpassword" id="oldpassword" class="form-control" placeholder="기존 비밀번호" required>
			            <label for="oldpassword">기존 비밀번호</label>
			        </div>
			
			        <!-- 새 비밀번호 -->
			        <div class="form-floating mb-3 w-75">
			            <input type="password" name="newpassword" id="newpassword" class="form-control" placeholder="새 비밀번호" required>
			            <label for="newpassword">새 비밀번호</label>
			        </div>
			
			        <!-- 새 비밀번호 확인 -->
			        <div class="form-floating mb-3 w-75">
			            <input type="password" name="newpassword2" id="newpassword2" class="form-control" placeholder="새 비밀번호 확인" required>
			            <label for="newpassword2">새 비밀번호 확인</label>
			            <div class="resultPassword2 mt-1 ps-2 small"></div>
			        </div>
			
			        <!-- 제출 버튼 -->
			        <div class="d-flex justify-content-center w-75">
			            <button type="submit" class="btn btn-primary w-50" id="submit" style="font-size: 16px; padding: 12px;" disabled>변경하기</button>
			        </div>
			
			    </form>
			
			</div>

			
			 	<!-- 내비게이터 -->
				<div class="d-flex flex-column align-items-end bg-light" style="height: 100%; width: 25%; gap:20px">
				    <div class="btn btn-outline-light bg-white text-dark shadow-sm mt-3" style="width: 100%"><a th:href="@{/member/mypage/main}" style="text-decoration: none; color:black;">회원 정보</a></div>
				    <div class="btn text-dark shadow" style="width: 100%; background-color: #e4e6e9; border-color: #e4e6e9"><a th:href="@{/member/mypage/upass}" style="text-decoration: none; color:black;">비밀번호 변경</a></div>
				    <div class="btn btn-outline-light bg-white text-dark shadow-sm" style="width: 100%"><a th:href="@{/member/mypage/uemail}" style="text-decoration: none; color:black;">이메일 변경</a></div>
				    <div class="btn btn-outline-light bg-white text-dark shadow-sm" style="width: 100%"><a th:href="@{/member/mypage/uaddress}" style="text-decoration: none; color:black;">주소 변경</a></div>
				    <div class="btn btn-outline-light bg-white text-dark shadow-sm" style="width: 100%"><a th:href="@{/member/mypage/umobile}" style="text-decoration: none; color:black;">휴대전화번호 변경</a></div>
				    <div class="btn btn-outline-light bg-white text-dark shadow-sm" style="width: 100%"><a th:href="@{/member/mypage/udname}" style="text-decoration: none; color:black;">별명 변경</a></div>
				    <div class="btn btn-outline-light bg-white text-dark shadow-sm mb-3" style="width: 100%; margin-top: auto;"><a th:href="@{/member/mypage/deleteAccount}" style="text-decoration: none; color: #f44949;">회원탈퇴</a></div>
				</div>
			</div>

			</div>

		</div>
	<script>
	// 비밀번호 일치 체크
	// 비밀번호 확인을 입력할 때
	$(function() {
		$("#newpassword2").on("keyup", function() {
			$(".resultPassword2").removeClass("d-none");
			let pass1 = $("#newpassword").val().trim();
			let pass2 = $(this).val().trim();
			
			if (pass2 === pass1) {
				$(".resultPassword2")
					.removeClass("fail text-danger")
					.addClass("success text-success")
					.html("✔️ 비밀번호가 일치합니다");
				$("#newpassword2")
                    .removeClass("is-invalid")
                    .addClass("is-valid");
				$("#submit")
					.prop("disabled", false);
			} else {
				$(".resultPassword2")
					.removeClass("success text-success")
					.addClass("fail text-danger")
					.html("❌ 비밀번호가 일치하지 않습니다");
				$("#newpassword2")
                    .removeClass("is-valid")
                    .addClass("is-invalid");
				$("#submit")
					.prop("disabled", true);
				
			}
		});
	});
	// 사용할 비밀번호를 입력할 때
	$(function() {
		$("#newpassword").on("keyup", function() {
			let pass1 = $(this).val().trim();
			let pass2 = $("#newpassword2").val().trim();
			
			if (pass2 !== "") {
				if (pass1 !== pass2) {
					$(".resultPassword2")
						.removeClass("success text-success d-none")
						.addClass("fail text-danger")
						.html("❌ 비밀번호가 일치하지 않습니다");
					$("#newpassword2")
	                    .removeClass("is-valid")
	                    .addClass("is-invalid");
					$("#submit")
						.prop("disabled", true);
				} else if (pass1 === pass2) {
					$(".resultPassword2")
						.removeClass("fail text-danger")
						.addClass("success text-success")
						.html("✔️ 비밀번호가 일치합니다");
					$("#submit")
						.prop("disabled", false);
					$("#newpassword2")
	                    .removeClass("is-invalid")
	                    .addClass("is-valid");
				}
			}
		});
	});
	// 포커스 벗어나면 알림 숨김 및 아무것도 없으면 초기화
	$(function() {
		$("#newpassword, #newpassword2").on("blur", function() {
			$(".resultPassword2").addClass("d-none");
			let pass1 = $("#newpassword").val().trim();
			let pass2 = $("#newpassword2").val().trim();
			
			if ((pass1==="")&&(pass2==="")) {
				$(".resultPassword2") .removeClass("success text-success fail text-danger");
				$("#newpassword2").removeClass("is-valid is-invalid");
				$("#submit") .prop("disabled", true);
			}
		});
	});
	</script>
	<script>
  	// memberId값으로 displayName 값 가져오기
  	 $(document).ready(function() {
         var memberId2 = $("#memberId2").text().trim();

         $.ajax({
             url: "/40db/getDisplayNameByMemberId",
             method: "GET",
             data: { memberId: memberId2 },
             success: function(displayName) {
                 $('#displayName2').text(displayName);
             },
             error: function() {
                 console.log("displayName을 가져오는 데 실패했습니다.");
             }
         });
     });
	</script>
	<script th:if="${success}" th:inline="javascript"> alert([[${success}]]);</script>
 	<script th:if="${fail}" th:inline="javascript"> alert([[${fail}]]);</script>

	</div>
</body>
</html>